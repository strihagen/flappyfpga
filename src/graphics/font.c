/*  FONT rendering
 *
 * File: font.c
 * Author: Eric Strihagen
 * Date: 2025-11-29
 *
 * Declaration file: graphics/font.h
*/

#include "game/game.h"
#include "drivers/vga.h"
#include "graphics/sprite.h"
#include "graphics/renderer.h"

#define FONT_WIDTH 16
#define FONT_HEIGHT 16

#define CURRENT_CHARS 128

static sprite_t* font_table[CURRENT_CHARS];

// char sprites
static sprite_t sprite_G;
static sprite_t sprite_A;
static sprite_t sprite_M;
static sprite_t sprite_E;

static sprite_t sprite_O;
static sprite_t sprite_V;
static sprite_t sprite_R;

static sprite_t sprite_F;
static sprite_t sprite_L;
static sprite_t sprite_P;
static sprite_t sprite_Y;


// 1-bit mask (1 = pixel on, 0 = transparent)
static const uint8_t FONT_G[FONT_WIDTH * FONT_HEIGHT] = {
    0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,
    0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,
    0,0,1,1,1,1,0,0,0,0,0,1,1,1,1,1,
    0,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,
    0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,
    1,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1,
    1,1,1,0,0,0,0,0,1,1,1,1,1,1,1,1,
    1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,1,0,
    0,0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,
    0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,
    0,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0
};

static const uint8_t FONT_A[FONT_WIDTH * FONT_HEIGHT] = {
    0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,
    0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,
    0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,
    0,0,0,0,1,1,0,0,0,0,1,1,0,0,0,0,
    0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,
    0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,
    0,0,0,1,1,0,0,0,0,0,0,1,1,0,0,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0,
    0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,
    0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,
    0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,
    0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,
    0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0,
    0,1,1,0,0,0,0,0,0,0,0,0,0,1,1,0
};
static const uint8_t FONT_M[FONT_WIDTH * FONT_HEIGHT] = {
    1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,
    1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,
    1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,
    1,1,1,1,1,1,0,0,0,0,1,1,1,1,1,1,
    1,1,1,1,1,1,1,0,0,1,1,1,1,1,1,1,
    1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,
    1,1,1,0,1,1,1,1,1,1,1,1,0,1,1,1,
    1,1,1,0,0,1,1,1,1,1,1,0,0,1,1,1,
    1,1,1,0,0,0,0,1,1,0,0,0,0,1,1,1,
    1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,
    1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,
    1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,
    1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,
    1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,
    1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1,
    1,1,1,0,0,0,0,0,0,0,0,0,0,1,1,1
};

static const uint8_t FONT_E[FONT_WIDTH * FONT_HEIGHT] = {
    0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,
    0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,1,0,0,0,0,0,0,0,
    0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,
    0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,1,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,
    0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,
    0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0
};


static const uint8_t FONT_O[FONT_WIDTH * FONT_HEIGHT] = {
    0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,
    0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,
    0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,
    0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,
    0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,
    0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,
    0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0
};

static const uint8_t FONT_V[FONT_WIDTH * FONT_HEIGHT] = {
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,0,0,
    0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,
    0,0,0,1,1,1,0,0,0,0,1,1,1,0,0,0,
    0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,
    0,0,0,0,1,1,1,0,0,1,1,1,0,0,0,0,
    0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,
    0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,
    0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0
};

static const uint8_t FONT_R[FONT_WIDTH * FONT_HEIGHT] = {
    0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,
    0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,
    0,0,1,1,1,0,0,0,0,0,1,1,1,1,0,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,0,0,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,0,0,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,0,0,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,1,1,1,1,0,0,
    0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,
    0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,
    0,0,1,1,1,0,0,1,1,1,1,0,0,0,0,0,
    0,0,1,1,1,0,0,0,1,1,1,1,0,0,0,0,
    0,0,1,1,1,0,0,0,0,1,1,1,1,0,0,0,
    0,1,1,1,1,0,0,0,0,0,1,1,1,1,0,0,
    0,1,1,1,1,0,0,0,0,0,0,1,1,1,1,0
};


static const uint8_t FONT_F[FONT_WIDTH * FONT_HEIGHT] = {
    0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,
    0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,
    0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,
    0,0,1,1,1,1,1,1,1,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,1,1,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0
};

static const uint8_t FONT_L[FONT_WIDTH * FONT_HEIGHT] = {
    0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,0,1,0,
    0,0,1,1,0,0,0,0,0,0,0,0,0,1,1,0,
    0,0,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,
    0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,0
};

static const uint8_t FONT_P[FONT_WIDTH * FONT_HEIGHT] = {
    0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,
    0,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,
    0,0,1,1,1,0,0,0,0,0,1,1,1,1,0,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,0,0,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,0,0,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,0,0,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,0,1,1,1,1,0,
    0,0,1,1,1,0,0,0,0,0,1,1,1,1,0,0,
    0,0,1,1,1,1,1,1,1,1,1,1,1,0,0,0,
    0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,
    0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,
    0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,
    0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,
    0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0
};


static const uint8_t FONT_Y[FONT_WIDTH * FONT_HEIGHT] = {
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,0,0,0,0,0,0,0,0,1,1,1,0,
    0,1,1,1,1,0,0,0,0,0,0,1,1,1,1,0,
    0,0,1,1,1,1,0,0,0,0,1,1,1,1,0,0,
    0,0,0,1,1,1,1,0,0,1,1,1,1,0,0,0,
    0,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,
    0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,
    0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,
    0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0
};



/* Unused basic setup for future letters
static const uint8_t FONT__[FONT_WIDTH * FONT_HEIGHT] = {
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
};
*/

void font_init() {
    font_table['G'] = &sprite_G;
    sprite_G.width  = FONT_WIDTH;
    sprite_G.height = FONT_HEIGHT;
    sprite_G.bitmap = FONT_G;

    font_table['A'] = &sprite_A;
    sprite_A.width  = FONT_WIDTH;
    sprite_A.height = FONT_HEIGHT;
    sprite_A.bitmap = FONT_A;

    font_table['M'] = &sprite_M;
    sprite_M.width  = FONT_WIDTH;
    sprite_M.height = FONT_HEIGHT;
    sprite_M.bitmap = FONT_M;

    font_table['E'] = &sprite_E;
    sprite_E.width  = FONT_WIDTH;
    sprite_E.height = FONT_HEIGHT;
    sprite_E.bitmap = FONT_E;

    font_table['O'] = &sprite_O;
    sprite_O.width  = FONT_WIDTH;
    sprite_O.height = FONT_HEIGHT;
    sprite_O.bitmap = FONT_O;

    font_table['V'] = &sprite_V;
    sprite_V.width  = FONT_WIDTH;
    sprite_V.height = FONT_HEIGHT;
    sprite_V.bitmap = FONT_V;

    font_table['R'] = &sprite_R;
    sprite_R.width  = FONT_WIDTH;
    sprite_R.height = FONT_HEIGHT;
    sprite_R.bitmap = FONT_R;

    font_table['F'] = &sprite_F;
    sprite_F.width  = FONT_WIDTH;
    sprite_F.height = FONT_HEIGHT;
    sprite_F.bitmap = FONT_F;

    font_table['L'] = &sprite_L;
    sprite_L.width  = FONT_WIDTH;
    sprite_L.height = FONT_HEIGHT;
    sprite_L.bitmap = FONT_L;

    font_table['P'] = &sprite_P;
    sprite_P.width  = FONT_WIDTH;
    sprite_P.height = FONT_HEIGHT;
    sprite_P.bitmap = FONT_P;

    font_table['Y'] = &sprite_Y;
    sprite_Y.width  = FONT_WIDTH;
    sprite_Y.height = FONT_HEIGHT;
    sprite_Y.bitmap = FONT_Y;
}


const sprite_t *font_get_char(int c) {
    return font_table[c];
}

void font_render_string(const char *str, int x, int y, color_t color)
{
    int cursorX = x;

    for (int i = 0; str[i]; i++) {

        char c = str[i];
        if (c == ' ') {
            cursorX += FONT_WIDTH;
            continue;
        }

        sprite_t *spr = font_table[(unsigned char)c];
        if (!spr)
            continue; // unsupported

        spr->x = cursorX;
        spr->y = y;

        renderer_draw_sprite(spr, color);
        cursorX += FONT_WIDTH;
    }
}

// simple 32-step vertical ripple (-4 to +4)
static const int8_t ripple_lookup[32] = {
     0,1,2,3,4,3,2,1,
     0,-1,-2,-3,-4,-3,-2,-1,
     0,1,2,3,4,3,2,1,
     0,-1,-2,-3,-4,-3,-2,-1
};

void font_render_string_wave(const char *str, int x, int baseY, color_t color)
{
    int cursorX = x;
    game_state_t* GAME_STATE = game_state_get();

    for (int i = 0; str[i]; i++) {

        char c = str[i];
        if (c == ' ') {
            cursorX += FONT_WIDTH;
            continue;
        }

        sprite_t *spr = font_table[(unsigned char)c];
        if (!spr) continue;

        int phase = ((GAME_STATE->frame >> 2) + i * 5) & 31;     // 0–31
        int yOffset = ripple_lookup[phase];

        spr->x = cursorX;
        spr->y = baseY + yOffset;

        renderer_draw_sprite(spr, color);

        cursorX += FONT_WIDTH;
    }
}

void font_render_string_float(const char *str, int x, int baseY, color_t color)
{
    int cursorX = x;
    game_state_t* GAME_STATE = game_state_get();

    // Slow down movement (>> 3 = 8× slower)
    int slowFrame = GAME_STATE->frame >> 3;

    // Use our 32-step lookup
    int phase = slowFrame & 31;
    int yOffset = ripple_lookup[phase];

    for (int i = 0; str[i]; i++) {

        char c = str[i];
        if (c == ' ') {
            cursorX += FONT_WIDTH;
            continue;
        }

        sprite_t *spr = font_table[(unsigned char)c];
        if (!spr) continue;

        spr->x = cursorX;
        spr->y = baseY + yOffset;

        renderer_draw_sprite(spr, color);

        cursorX += FONT_WIDTH;
    }
}

